!function(){function n(n){if(!n)return null;let a=(n=String(n).trim().replace(",",".")).match(/^(\d{1,2}):(\d{1,2})$/);if(a){let n=parseInt(a[1],10),e=parseInt(a[2],10);return isNaN(n)||isNaN(e)?null:(e>=60&&(n+=Math.floor(e/60),e%=60),n+e/60)}if(a=n.match(/^(\d{1,2})(?:\.(\d{1,2}))?$/),a){let n=parseInt(a[1],10),e=a[2]?parseInt(a[2],10):0,i=a[2]?Math.pow(10,a[2].length):1,o=Math.round(e/i*60);return o>=60&&(n+=1,o=0),n+o/60}return null}function a(a){if(!a||!a.value)return;const e=n(a.value);if(null===e)return;let i=Math.floor(e),o=Math.round(60*(e-i));o>=60&&(i+=1,o=0),a.value=String(i).padStart(2,"0")+":"+String(o).padStart(2,"0")}function e(n,a,e){return Math.max(a,Math.min(e,n))}function i(n){const a=Number(n)||0;return{fCHO:e(1+.02*(a-6),.9,1.12),fHyd:e(1+.01*(a-6),.94,1.08),fSpeed:e(1+.015*(a-6),.92,1.1)}}function o(n){const a=Number(n)||0;return{fHydAge:e(1+.001*(35-a),.97,1.03),fSpeedAge:e(1-.0015*(a-35),.9,1.06)}}function t(n,a=0){const e=Math.pow(10,a);return Math.round(n*e)/e}const r=[{nombre:"Zócalo → La Loma",kmIni:0,kmFin:50},{nombre:"La Loma → Cañón de Lobos",kmIni:50,kmFin:110},{nombre:"Cañón de Lobos → Tres Marías",kmIni:110,kmFin:145},{nombre:"Tres Marías → Meta (C.U.)",kmIni:145,kmFin:187}],d=[{nombre:"Zócalo → La Loma",kmIni:0,kmFin:50,gain:733},{nombre:"La Loma → Cañón de Lobos",kmIni:50,kmFin:110,gain:304},{nombre:"Cañón de Lobos → Tres Marías",kmIni:110,kmFin:145,gain:1479},{nombre:"Tres Marías → Meta (C.U.)",kmIni:145,kmFin:187,gain:357}],l=function(){let n=0;return d.forEach(a=>{const e=a.kmFin-a.kmIni;if(e>0){const i=a.gain/e;i>n&&(n=i)}}),n>0?n:1}(),s=n=>document.querySelector(n),c={edad:s("#edad"),est:s("#estatura"),peso:s("#peso"),nivel:s("#nivel"),horas:s("#horas"),objetivo:s("#objetivo"),clima:s("#clima"),sudor:s("#sudor"),tol:s("#tolerancia"),bidon:s("#bidon"),cafe:s("#cafe"),mgkg:s("#mgkg"),tipoBici:s("#tipoBici"),pesoBici:s("#pesoBici"),rodada:s("#rodada"),anchoLlanta:s("#anchoLlanta")};c.objetivo&&c.objetivo.addEventListener("blur",function(){a(c.objetivo)});const m=s("#generar"),u=s("#limpiar"),v=s("#salida"),g=s("#kpi"),p=s("#objetivos"),f=s("#segmentos"),b=s("#raciones"),h=s("#descargar"),$=s("#avisoCafe");u.addEventListener("click",()=>{document.getElementById("perfil").reset(),v.hidden=!0,g.innerHTML=p.innerHTML=f.innerHTML=b.innerHTML="",$&&($.hidden=!0,$.innerHTML="")}),m.addEventListener("click",s=>{s.preventDefault();const m=Number(c.edad.value||0),u=Number(c.est.value||0),M=Number(c.peso.value||0),k=c.nivel.value,L=Number(c.horas.value||0),N=c.clima.value,H=c.sudor.value,B=c.tol.value,I=Number(c.bidon.value),T="si"===c.cafe.value,j=e(Number(c.mgkg.value||0),0,6),C=e(I||600,200,1200),y=c.tipoBici&&c.tipoBici.value?c.tipoBici.value:null,F=c.pesoBici&&c.pesoBici.value?e(Number(c.pesoBici.value),5,25):null,S=c.rodada&&c.rodada.value?c.rodada.value:null,x=c.anchoLlanta&&c.anchoLlanta.value?e(Number(c.anchoLlanta.value),18,65):null;if(!(m&&u&&M&&L))return void alert("Completa edad, estatura, peso y horas de entrenamiento/semana.");a(c.objetivo);let A=n(c.objetivo.value||""),E=null!==A;const O="avanzado"===k?9.5:"intermedio"===k?10.5:11.5;let w=1,P=1,U=1,q=1;E||(w=function({tipoBici:n=null,pesoBici:a=null,rodada:i=null,anchoLlanta:o=null}){const t=n||"ruta";let r={ruta:1,gravel:.97,mtb:.93,fixie:.98}[t]||1;const d={ruta:8.5,gravel:9.5,mtb:12,fixie:9}[t]||9.5;return r*=e(1-.004*("number"!=typeof a||isNaN(a)?0:a-d),.94,1.06),"29"===i?r*=.992:"650b"===i?r*=.99:"27.5"===i?r*=.995:"26"===i?r*=.988:"700c"===i&&(r*=1),"number"!=typeof o||isNaN(o)||(o>=45?r*=.98:o>=35?r*=.99:o>=28&&(r*=.995)),e(r,.88,1.08)}({tipoBici:y,pesoBici:F,rodada:S,anchoLlanta:x}),P=i(L).fSpeed,U=o(m).fSpeedAge,q=e(w*P*U,.86,1.12),A=t(O/q,2));const{gHora:R,mlHora:z,naHora:D}=function({peso:n,nivel:a,tolerancia:t,clima:r,sudor:d,tiempoObjetivo:l=null,tipoBici:s=null,pesoBici:c=null,rodada:m=null,anchoLlanta:u=null,edad:v=null,est:g=null,horasSem:p=null}){let f=60;"alta"===t&&(f=80),"baja"===t&&(f=50);const b=e(.8+("alta"===t?.2:"baja"===t?-.1:0),.6,1.2);let h=Math.round(e(b*n,45,90));"avanzado"===a&&(h=Math.max(h,f+5)),"nuevo"===a&&(h=Math.min(h,f));let $=600;"frio"===r&&($=400),"calor"===r&&($=850),"alta"===d&&($+=100),"salada"===d&&($+=150),$=e($,300,1100);let M=450;"calor"===r&&(M=700),"alta"===d&&(M+=150),"salada"===d&&(M+=250),M=e(M,300,1200);const{fCHO:k,fHyd:L,fSpeed:N}=i(p),{fHydAge:H}=o(v),B=function(n,a){const e=Number(n)||0,i=Number(a)||0;return e&&i?Math.sqrt(e*i/3600):1.9}(g,n),I=e(1+.05*(B-1.9),.95,1.05);h=Math.round(e(h*k,45,100));const T=$;$=Math.round(e($*L*H*I,300,1100));const j=e($/T,.9,1.12);if(M=Math.round(e(M*(1+.9*(j-1)),300,1200)),l&&l>0){const n=10.5-l,a="calor"===r?.04:.03,i=e(1+n*a,.9,"calor"===r?1.15:1.1);$=Math.round(e($*i,300,1100));const o=e(1+n*(.85*a),.9,"calor"===r?1.14:1.09);M=Math.round(e(M*o,300,1200));const t=e(1+.02*n,.93,1.07);h=Math.round(e(h*t,45,100)),l>=12?($=Math.round(e(1.02*$,300,1100)),M=Math.round(e(1.02*M,300,1200))):l<=9&&($=Math.round(e(.98*$,300,1100)),M=Math.round(e(.98*M,300,1200)))}if(s||c||m||u){const n={ruta:1,gravel:1.03,mtb:1.05,fixie:1.02},a={ruta:1,gravel:1.02,mtb:1.04,fixie:1.02},i=s||"ruta",o={ruta:8.5,gravel:9.5,mtb:12,fixie:9}[i]||9.5;let t=0;"number"!=typeof c||isNaN(c)||(t=c-o);const r=e(1+.015*t,.95,1.12),d=e(1+.008*t,.96,1.08);let l=1,v=1;"29"===m||"650b"===m?(l*=1.01,v*=1.01):"27.5"===m?(l*=1.005,v*=1.005):"26"===m&&(l*=.995,v*=.995);let g=1,p=1;"number"!=typeof u||isNaN(u)||(u>=45?(g*=1.03,p*=1.02):u>=35?(g*=1.02,p*=1.01):u>=28&&(g*=1.01));const f=e((n[i]||1)*r*l*g,.93,1.15),b=e((a[i]||1)*d*v*p,.92,1.14);h=Math.round(e(h*f,45,100));const k=$;$=Math.round(e($*b,300,1100));const L=e($/k,.9,1.12),N=e(1+.9*(L-1),.9,1.12);M=Math.round(e(M*N,300,1200))}return{gHora:h,mlHora:$,naHora:M,_interno:{fCHO:k,fHyd:L,fSpeed:N,bsa:B}}}({peso:M,nivel:k,tolerancia:B,clima:N,sudor:H,tiempoObjetivo:E?A:null,tipoBici:y,pesoBici:F,rodada:S,anchoLlanta:x,edad:m,est:u,horasSem:L}),V=187/A,_=E?"Tiempo específico":"Estimación automática",G=M/Math.pow(u/100,2),X=E?"":`\n          <div><div class="muted">Ajuste bici/entreno/edad</div><div class="mono">×${t(q,2)} (bici ${t(w,2)} · entreno ${t(P,2)} · edad ${t(U,2)})</div></div>`;g.innerHTML=`\n          <div><div class="muted">Tiempo objetivo</div><div class="mono">${t(A,2)} h</div></div>\n          <div><div class="muted">Velocidad promedio</div><div class="mono">${t(V,1)} km/h</div></div>\n          <div><div class="muted">IMC (ref.)</div><div class="mono">${t(G,1)}</div></div>\n          <div><div class="muted">Entreno/sem</div><div class="mono">${L} h</div></div>\n          <div><div class="muted">Clima</div><div class="mono">${N}</div></div>\n          <div><div class="muted">Modo cálculo</div><div class="mono">${_}</div></div>\n          ${X}`;const Y=Math.round(j*M),Z=Math.min(Y,400),J=T&&Y>400;if(p.innerHTML=`\n          <li>Hidratos: <strong>${R} g/h</strong></li>\n          <li>Sodio: <strong>${D} mg/h</strong></li>\n          <li>Líquidos: <strong>${z} ml/h</strong> &nbsp; (bidón ${C} ml → ~${t(z/C,2)} bidones/h)</li>\n          ${T?`<li>Cafeína total orientativa: <strong>${Z}</strong> mg (máx. salud 400 mg; sugerencia ≤200 mg por toma)</li>`:""}\n          ${J?`<li class="muted">Advertencia: ingresaste ${Y} mg; se limita a 400 mg por seguridad.</li>`:""}`,I&&I!==C?p.innerHTML+=`<li class="muted">Nota: bidón ajustado a ${C} ml para cálculos (entrada: ${I} ml).</li>`:I||(p.innerHTML+=`<li class="muted">Nota: sin valor de bidón; se usa ${C} ml por defecto.</li>`),$)if(T){const n="\n              <strong>Advertencia de cafeína:</strong> máximo 400 mg totales en el día y ≤200 mg por toma.\n            ",a=J?` Ingresaste ${Y} mg; se limitará a 400 mg por seguridad.`:"";$.innerHTML=n+a,$.hidden=!1}else $.innerHTML="",$.hidden=!0;let K=[];f.innerHTML="";let Q=0,W=0,nn=0,an=0;r.forEach(n=>{const a=function(n,a){const e=n.kmFin-n.kmIni,i=d.find(a=>a.kmIni===n.kmIni&&a.kmFin===n.kmFin),o=i?i.gain:0,t=e*(1+2*(l>0?(e>0?o/e:0)/l:0)),r=d.reduce((n,a)=>{const e=a.kmFin-a.kmIni;if(e<=0)return n;const i=a.gain/e;return n+e*(1+2*(l>0?i/l:0))},0);return(r>0?t/r:e/187)*a}(n,A),{fCHO:i,fHYD:o,fNA:r}=function(n,{tipoBici:a,pesoBici:i,rodada:o,anchoLlanta:t}){const r=n.kmFin-n.kmIni,s=d.find(a=>a.kmIni===n.kmIni&&a.kmFin===n.kmFin),c=s?s.gain:0,m=l>0?(r>0?c/r:0)/l:0,u=function({tipoBici:n=null,rodada:a=null,anchoLlanta:i=null}){let o={ruta:0,gravel:.03,mtb:.06,fixie:.02}[n||"ruta"]||0;return"29"===a||"650b"===a?o+=.008:"27.5"===a?o+=.004:"26"===a&&(o+=.01),"number"!=typeof i||isNaN(i)||(i>=45?o+=.03:i>=35?o+=.015:i>=28&&(o+=.008)),e(o,0,.12)}({tipoBici:a,rodada:o,anchoLlanta:t}),v=function({tipoBici:n=null,pesoBici:a=null}){const i={ruta:8.5,gravel:9.5,mtb:12,fixie:9}[n||"ruta"]||9.5;return e("number"!=typeof a||isNaN(a)?0:a-i,-4,10)}({tipoBici:a,pesoBici:i});return{fCHO:e(1+.12*m+.02*u+.01*v,.95,1.3),fHYD:e(1+.08*m+.01*u+.005*v,.92,1.25),fNA:e(1+.08*m+.01*u+.004*v,.92,1.25),slopeNorm:m,dIdx:u,mIdx:v}}(n,{tipoBici:y,pesoBici:F,rodada:S,anchoLlanta:x}),s=Math.round(e(R*i,45,120)*a),c=Math.round(e(z*o,300,1400)*a),m=Math.round(e(D*r,300,1400)*a),u=Math.ceil(c/C);Q+=s,W+=m,nn+=c,an+=u;const v=d.find(a=>a.kmIni===n.kmIni&&a.kmFin===n.kmFin),g=v?v.gain:0,p=`<div class="card"><strong>${n.nombre}</strong> — ${t(a,2)} h<div>Hidratos: <strong>${s} g</strong> | Sodio: <strong>${m} mg</strong> | Líquidos: <strong>${c} ml</strong> (~${u} bidones)</div><div class="muted">GPX: +${g} m · variación por pendiente/bici aplicada</div></div>`;f.insertAdjacentHTML("beforeend",p),K.push(`${n.nombre} (${t(a,2)} h): ${s} g CHO | ${m} mg Na | ${c} ml (~${u} bidones) | GPX +${g} m`)}),b.innerHTML=["1 gel: ~25 g","1 plátano mediano: ~25 g","8 dátiles (~50 g): ~28 g","1 barra típica: ~25 g","sándwich sencillo: ~45 g","tortilla + crema de cacahuate: ~30 g","papas cocidas saladas (1 taza): ~30 g","gominolas porción: ~30 g"].map(n=>`<li>${n}</li>`).join("");const en=`<div class="card"><strong>Totales estimados para ${t(A,2)} h</strong><div>Hidratos: <strong>${Q} g</strong> | Sodio: <strong>${W} mg</strong> | Líquidos: <strong>${nn} ml</strong> (~${an} bidones)</div></div>`;f.insertAdjacentHTML("beforeend",en);const on=`Bicicleta: ${y||"—"} | Peso: ${null!=F?F+" kg":"—"} | Rodada: ${S||"—"} | Ancho: ${null!=x?x+" mm":"—"}`,tn=T?`Cafeína: ${j} mg/kg → ${Z} mg total${J?" (limitado a 400 mg por salud)":""}`:"Cafeína: no",rn=E?"":`Ajuste bici/entreno/edad: ×${t(q,2)} (bici ${t(w,2)} · entreno ${t(P,2)} · edad ${t(U,2)})\n`,dn=I&&I!==C?`\nNota: bidón ajustado a ${C} ml para cálculos (entrada: ${I} ml).`:I?"":`\nNota: sin valor de bidón; se usa ${C} ml por defecto.`,ln=`Vuelta al Cóndor — Plan personal\nTiempo objetivo: ${t(A,2)} h\nVelocidad promedio: ${t(V,1)} km/h\nModo de cálculo: ${_}\n${rn}Entreno/sem: ${L} h\nIMC (ref.): ${t(G,1)}\nEdad: ${m}, Estatura: ${u} cm, Peso: ${M} kg, Nivel: ${k}\n${on}\nClima: ${N}, Sudoración: ${H}, Tolerancia: ${B}\n${tn}\nObjetivos/h: ${R} g CHO | ${D} mg Na | ${z} ml (bidón ${C} ml)${dn}\n\nPor segmento:\n${K.map(n=>" - "+n).join("\n")}\n\nTotales: ${Q} g CHO | ${W} mg Na | ${nn} ml (~${an} bidones)\nNotas:\n- Ajusta por sensaciones; ensaya tu estrategia en tiradas largas.\n- Advertencia cafeína: máx. 400 mg totales en el día y ≤200 mg por toma; evita si tienes hipertensión, arritmias o sensibilidad.\n- Nada se almacena. Este archivo es solo para ti.\n`;h.onclick=()=>{const n=new Blob([ln],{type:"text/plain"}),a=URL.createObjectURL(n),e=document.createElement("a");e.href=a,e.download="plan_personal_condor.txt",document.body.appendChild(e),e.click(),URL.revokeObjectURL(a),e.remove()},v.hidden=!1,window.scrollTo({top:v.offsetTop-20,behavior:"smooth"})})}();