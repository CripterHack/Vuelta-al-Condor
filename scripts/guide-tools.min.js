!function(){function n(n){if(null==n)return NaN;const a=String(n).trim().replace(",","."),i=Number(a);return Number.isFinite(i)?i:NaN}function a(n){if(!n)return null;let a=(n=String(n).trim().replace(",",".")).match(/^(\d{1,2}):(\d{1,2})$/);if(a){let n=parseInt(a[1],10),i=parseInt(a[2],10);return isNaN(n)||isNaN(i)?null:(i>=60&&(n+=Math.floor(i/60),i%=60),n+i/60)}if(a=n.match(/^(\d{1,2})(?:\.(\d{1,2}))?$/),a){let n=parseInt(a[1],10),i=a[2]?parseInt(a[2],10):0,e=a[2]?Math.pow(10,a[2].length):1,o=Math.round(i/e*60);return o>=60&&(n+=1,o=0),n+o/60}return null}function i(n){if(!n||!n.value)return;const i=a(n.value);if(null===i)return;let e=Math.floor(i),o=Math.round(60*(i-e));o>=60&&(e+=1,o=0),n.value=String(e).padStart(2,"0")+":"+String(o).padStart(2,"0")}function e(n,a,i){return Math.max(a,Math.min(i,n))}function o(n){const a=Number(n)||0;return{fCHO:e(1+.02*(a-6),.9,1.12),fHyd:e(1+.01*(a-6),.94,1.08),fSpeed:e(1+.015*(a-6),.92,1.1)}}function t(n){const a=Number(n)||0;return{fHydAge:e(1+.001*(35-a),.97,1.03),fSpeedAge:e(1-.0015*(a-35),.9,1.06)}}function r(n,a=0){const i=Math.pow(10,a);return Math.round(n*i)/i}const d=[{nombre:"Zócalo → La Loma",kmIni:0,kmFin:50},{nombre:"La Loma → Cañón de Lobos",kmIni:50,kmFin:110},{nombre:"Cañón de Lobos → Tres Marías",kmIni:110,kmFin:145},{nombre:"Tres Marías → Meta (C.U.)",kmIni:145,kmFin:187}],l=[{nombre:"Zócalo → La Loma",kmIni:0,kmFin:50,gain:733},{nombre:"La Loma → Cañón de Lobos",kmIni:50,kmFin:110,gain:304},{nombre:"Cañón de Lobos → Tres Marías",kmIni:110,kmFin:145,gain:1479},{nombre:"Tres Marías → Meta (C.U.)",kmIni:145,kmFin:187,gain:357}],s=function(){let n=0;return l.forEach(a=>{const i=a.kmFin-a.kmIni;if(i>0){const e=a.gain/i;e>n&&(n=e)}}),n>0?n:1}(),c=n=>document.querySelector(n),m={edad:c("#edad"),est:c("#estatura"),peso:c("#peso"),nivel:c("#nivel"),horas:c("#horas"),objetivo:c("#objetivo"),clima:c("#clima"),sudor:c("#sudor"),tol:c("#tolerancia"),bidon:c("#bidon"),cafe:c("#cafe"),mgkg:c("#mgkg"),tipoBici:c("#tipoBici"),pesoBici:c("#pesoBici"),rodada:c("#rodada"),anchoLlanta:c("#anchoLlanta")};m.objetivo&&m.objetivo.addEventListener("blur",function(){i(m.objetivo)});const u=c("#generar"),v=c("#limpiar"),g=c("#salida"),p=c("#kpi"),f=c("#objetivos"),h=c("#segmentos"),b=c("#raciones"),$=c("#descargar"),M=c("#avisoCafe"),L=c("#avisoError");v.addEventListener("click",()=>{document.getElementById("perfil").reset(),g.hidden=!0,p.innerHTML=f.innerHTML=h.innerHTML=b.innerHTML="",M&&(M.hidden=!0,M.innerHTML="")}),u.addEventListener("click",c=>{c.preventDefault();const u=n(m.edad.value),v=n(m.est.value),k=n(m.peso.value),N=m.nivel.value,H=n(m.horas.value),B=m.clima.value,T=m.sudor.value,I=m.tol.value,j=n(m.bidon.value),C="si"===m.cafe.value,F=e(n(m.mgkg.value),0,6),y=e(Number.isFinite(j)?j:600,200,1200),S=m.tipoBici&&m.tipoBici.value?m.tipoBici.value:null,x=m.pesoBici&&m.pesoBici.value?e(n(m.pesoBici.value),5,25):null,A=m.rodada&&m.rodada.value?m.rodada.value:null,E=m.anchoLlanta&&m.anchoLlanta.value?e(n(m.anchoLlanta.value),18,65):null;if(!(Number.isFinite(u)&&u>0&&Number.isFinite(v)&&v>0&&Number.isFinite(k)&&k>0&&Number.isFinite(H)&&H>=0))return function(n){if(L){L.innerHTML=n,L.hidden=!1;try{L.focus()}catch(n){}}else alert(n)}("Completa edad, estatura y peso. Las horas pueden ser 0."),void(g.hidden=!0);L&&(L.hidden=!0,L.innerHTML=""),i(m.objetivo);let O=a(m.objetivo.value||""),w=null!==O;const P="avanzado"===N?9.5:"intermedio"===N?10.5:11.5;let U=1,q=1,R=1,z=1;w||(U=function({tipoBici:n=null,pesoBici:a=null,rodada:i=null,anchoLlanta:o=null}){const t=n||"ruta";let r={ruta:1,gravel:.97,mtb:.93,fixie:.98}[t]||1;const d={ruta:8.5,gravel:9.5,mtb:12,fixie:9}[t]||9.5;return r*=e(1-.004*("number"!=typeof a||isNaN(a)?0:a-d),.94,1.06),"29"===i?r*=.992:"650b"===i?r*=.99:"27.5"===i?r*=.995:"26"===i?r*=.988:"700c"===i&&(r*=1),"number"!=typeof o||isNaN(o)||(o>=45?r*=.98:o>=35?r*=.99:o>=28&&(r*=.995)),e(r,.88,1.08)}({tipoBici:S,pesoBici:x,rodada:A,anchoLlanta:E}),q=o(H).fSpeed,R=t(u).fSpeedAge,z=e(U*q*R,.86,1.12),O=r(P/z,2));const{gHora:D,mlHora:V,naHora:_}=function({peso:n,nivel:a,tolerancia:i,clima:r,sudor:d,tiempoObjetivo:l=null,tipoBici:s=null,pesoBici:c=null,rodada:m=null,anchoLlanta:u=null,edad:v=null,est:g=null,horasSem:p=null}){let f=60;"alta"===i&&(f=80),"baja"===i&&(f=50);const h=e(.8+("alta"===i?.2:"baja"===i?-.1:0),.6,1.2);let b=Math.round(e(h*n,45,90));"avanzado"===a&&(b=Math.max(b,f+5)),"nuevo"===a&&(b=Math.min(b,f));let $=600;"frio"===r&&($=400),"calor"===r&&($=850),"alta"===d&&($+=100),"salada"===d&&($+=150),$=e($,300,1100);let M=450;"calor"===r&&(M=700),"alta"===d&&(M+=150),"salada"===d&&(M+=250),M=e(M,300,1200);const{fCHO:L,fHyd:k,fSpeed:N}=o(p),{fHydAge:H}=t(v),B=function(n,a){const i=Number(n)||0,e=Number(a)||0;return i&&e?Math.sqrt(i*e/3600):1.9}(g,n),T=e(1+.05*(B-1.9),.95,1.05);b=Math.round(e(b*L,45,100));const I=$;$=Math.round(e($*k*H*T,300,1100));const j=e($/I,.9,1.12);if(M=Math.round(e(M*(1+.9*(j-1)),300,1200)),l&&l>0){const n=10.5-l,a="calor"===r?.04:.03,i=e(1+n*a,.9,"calor"===r?1.15:1.1);$=Math.round(e($*i,300,1100));const o=e(1+n*(.85*a),.9,"calor"===r?1.14:1.09);M=Math.round(e(M*o,300,1200));const t=e(1+.02*n,.93,1.07);b=Math.round(e(b*t,45,100)),l>=12?($=Math.round(e(1.02*$,300,1100)),M=Math.round(e(1.02*M,300,1200))):l<=9&&($=Math.round(e(.98*$,300,1100)),M=Math.round(e(.98*M,300,1200)))}if(s||c||m||u){const n={ruta:1,gravel:1.03,mtb:1.05,fixie:1.02},a={ruta:1,gravel:1.02,mtb:1.04,fixie:1.02},i=s||"ruta",o={ruta:8.5,gravel:9.5,mtb:12,fixie:9}[i]||9.5;let t=0;"number"!=typeof c||isNaN(c)||(t=c-o);const r=e(1+.015*t,.95,1.12),d=e(1+.008*t,.96,1.08);let l=1,v=1;"29"===m||"650b"===m?(l*=1.01,v*=1.01):"27.5"===m?(l*=1.005,v*=1.005):"26"===m&&(l*=.995,v*=.995);let g=1,p=1;"number"!=typeof u||isNaN(u)||(u>=45?(g*=1.03,p*=1.02):u>=35?(g*=1.02,p*=1.01):u>=28&&(g*=1.01));const f=e((n[i]||1)*r*l*g,.93,1.15),h=e((a[i]||1)*d*v*p,.92,1.14);b=Math.round(e(b*f,45,100));const L=$;$=Math.round(e($*h,300,1100));const k=e($/L,.9,1.12),N=e(1+.9*(k-1),.9,1.12);M=Math.round(e(M*N,300,1200))}return{gHora:b,mlHora:$,naHora:M,_interno:{fCHO:L,fHyd:k,fSpeed:N,bsa:B}}}({peso:k,nivel:N,tolerancia:I,clima:B,sudor:T,tiempoObjetivo:w?O:null,tipoBici:S,pesoBici:x,rodada:A,anchoLlanta:E,edad:u,est:v,horasSem:H}),G=187/O,X=w?"Tiempo específico":"Estimación automática",Y=k/Math.pow(v/100,2),Z=w?"":`\n          <div><div class="muted">Ajuste bici/entreno/edad</div><div class="mono">×${r(z,2)} (bici ${r(U,2)} · entreno ${r(q,2)} · edad ${r(R,2)})</div></div>`;p.innerHTML=`\n          <div><div class="muted">Tiempo objetivo</div><div class="mono">${r(O,2)} h</div></div>\n          <div><div class="muted">Velocidad promedio</div><div class="mono">${r(G,1)} km/h</div></div>\n          <div><div class="muted">IMC (ref.)</div><div class="mono">${r(Y,1)}</div></div>\n          <div><div class="muted">Entreno/sem</div><div class="mono">${H} h</div></div>\n          <div><div class="muted">Clima</div><div class="mono">${B}</div></div>\n          <div><div class="muted">Modo cálculo</div><div class="mono">${X}</div></div>\n          ${Z}`;const J=Math.round(F*k),K=Math.min(J,400),Q=C&&J>400;if(f.innerHTML=`\n          <li>Hidratos: <strong>${D} g/h</strong></li>\n          <li>Sodio: <strong>${_} mg/h</strong></li>\n          <li>Líquidos: <strong>${V} ml/h</strong> &nbsp; (bidón ${y} ml → ~${r(V/y,2)} bidones/h)</li>\n          ${C?`<li>Cafeína total orientativa: <strong>${K}</strong> mg (máx. salud 400 mg; sugerencia ≤200 mg por toma)</li>`:""}\n          ${Q?`<li class="muted">Advertencia: ingresaste ${J} mg; se limita a 400 mg por seguridad.</li>`:""}`,j&&j!==y?f.innerHTML+=`<li class="muted">Nota: bidón ajustado a ${y} ml para cálculos (entrada: ${j} ml).</li>`:j||(f.innerHTML+=`<li class="muted">Nota: sin valor de bidón; se usa ${y} ml por defecto.</li>`),M)if(C){const n="\n              <strong>Advertencia de cafeína:</strong> máximo 400 mg totales en el día y ≤200 mg por toma.\n            ",a=Q?` Ingresaste ${J} mg; se limitará a 400 mg por seguridad.`:"";M.innerHTML=n+a,M.hidden=!1}else M.innerHTML="",M.hidden=!0;let W=[];h.innerHTML="";let nn=0,an=0,en=0,on=0;d.forEach(n=>{const a=function(n,a){const i=n.kmFin-n.kmIni,e=l.find(a=>a.kmIni===n.kmIni&&a.kmFin===n.kmFin),o=e?e.gain:0,t=i*(1+2*(s>0?(i>0?o/i:0)/s:0)),r=l.reduce((n,a)=>{const i=a.kmFin-a.kmIni;if(i<=0)return n;const e=a.gain/i;return n+i*(1+2*(s>0?e/s:0))},0);return(r>0?t/r:i/187)*a}(n,O),{fCHO:i,fHYD:o,fNA:t}=function(n,{tipoBici:a,pesoBici:i,rodada:o,anchoLlanta:t}){const r=n.kmFin-n.kmIni,d=l.find(a=>a.kmIni===n.kmIni&&a.kmFin===n.kmFin),c=d?d.gain:0,m=s>0?(r>0?c/r:0)/s:0,u=function({tipoBici:n=null,rodada:a=null,anchoLlanta:i=null}){let o={ruta:0,gravel:.03,mtb:.06,fixie:.02}[n||"ruta"]||0;return"29"===a||"650b"===a?o+=.008:"27.5"===a?o+=.004:"26"===a&&(o+=.01),"number"!=typeof i||isNaN(i)||(i>=45?o+=.03:i>=35?o+=.015:i>=28&&(o+=.008)),e(o,0,.12)}({tipoBici:a,rodada:o,anchoLlanta:t}),v=function({tipoBici:n=null,pesoBici:a=null}){const i={ruta:8.5,gravel:9.5,mtb:12,fixie:9}[n||"ruta"]||9.5;return e("number"!=typeof a||isNaN(a)?0:a-i,-4,10)}({tipoBici:a,pesoBici:i});return{fCHO:e(1+.12*m+.02*u+.01*v,.95,1.3),fHYD:e(1+.08*m+.01*u+.005*v,.92,1.25),fNA:e(1+.08*m+.01*u+.004*v,.92,1.25),slopeNorm:m,dIdx:u,mIdx:v}}(n,{tipoBici:S,pesoBici:x,rodada:A,anchoLlanta:E}),d=Math.round(e(D*i,45,120)*a),c=Math.round(e(V*o,300,1400)*a),m=Math.round(e(_*t,300,1400)*a),u=Math.ceil(c/y);nn+=d,an+=m,en+=c,on+=u;const v=l.find(a=>a.kmIni===n.kmIni&&a.kmFin===n.kmFin),g=v?v.gain:0,p=`<div class="card"><strong>${n.nombre}</strong> — ${r(a,2)} h<div>Hidratos: <strong>${d} g</strong> | Sodio: <strong>${m} mg</strong> | Líquidos: <strong>${c} ml</strong> (~${u} bidones)</div><div class="muted">GPX: +${g} m · variación por pendiente/bici aplicada</div></div>`;h.insertAdjacentHTML("beforeend",p),W.push(`${n.nombre} (${r(a,2)} h): ${d} g CHO | ${m} mg Na | ${c} ml (~${u} bidones) | GPX +${g} m`)}),b.innerHTML=["1 gel: ~25 g","1 plátano mediano: ~25 g","8 dátiles (~50 g): ~28 g","1 barra típica: ~25 g","sándwich sencillo: ~45 g","tortilla + crema de cacahuate: ~30 g","papas cocidas saladas (1 taza): ~30 g","gominolas porción: ~30 g"].map(n=>`<li>${n}</li>`).join("");const tn=`<div class="card"><strong>Totales estimados para ${r(O,2)} h</strong><div>Hidratos: <strong>${nn} g</strong> | Sodio: <strong>${an} mg</strong> | Líquidos: <strong>${en} ml</strong> (~${on} bidones)</div></div>`;h.insertAdjacentHTML("beforeend",tn);const rn=`Bicicleta: ${S||"—"} | Peso: ${null!=x?x+" kg":"—"} | Rodada: ${A||"—"} | Ancho: ${null!=E?E+" mm":"—"}`,dn=C?`Cafeína: ${F} mg/kg → ${K} mg total${Q?" (limitado a 400 mg por salud)":""}`:"Cafeína: no",ln=w?"":`Ajuste bici/entreno/edad: ×${r(z,2)} (bici ${r(U,2)} · entreno ${r(q,2)} · edad ${r(R,2)})\n`,sn=j&&j!==y?`\nNota: bidón ajustado a ${y} ml para cálculos (entrada: ${j} ml).`:j?"":`\nNota: sin valor de bidón; se usa ${y} ml por defecto.`,cn=`Vuelta al Cóndor — Plan personal\nTiempo objetivo: ${r(O,2)} h\nVelocidad promedio: ${r(G,1)} km/h\nModo de cálculo: ${X}\n${ln}Entreno/sem: ${H} h\nIMC (ref.): ${r(Y,1)}\nEdad: ${u}, Estatura: ${v} cm, Peso: ${k} kg, Nivel: ${N}\n${rn}\nClima: ${B}, Sudoración: ${T}, Tolerancia: ${I}\n${dn}\nObjetivos/h: ${D} g CHO | ${_} mg Na | ${V} ml (bidón ${y} ml)${sn}\n\nPor segmento:\n${W.map(n=>" - "+n).join("\n")}\n\nTotales: ${nn} g CHO | ${an} mg Na | ${en} ml (~${on} bidones)\nNotas:\n- Ajusta por sensaciones; ensaya tu estrategia en tiradas largas.\n- Advertencia cafeína: máx. 400 mg totales en el día y ≤200 mg por toma; evita si tienes hipertensión, arritmias o sensibilidad.\n- Nada se almacena. Este archivo es solo para ti.\n`;$.onclick=()=>{const n=new Blob([cn],{type:"text/plain"}),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download="plan_personal_condor.txt",document.body.appendChild(i),i.click(),URL.revokeObjectURL(a),i.remove()},g.hidden=!1,window.scrollTo({top:g.offsetTop-20,behavior:"smooth"})})}();