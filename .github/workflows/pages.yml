name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Build CSS (autoprefix + minify)
        run: |
          pnpm run css:prefix
          pnpm run css:build
      - name: Minify JS (exclude feedback.js)
        run: |
          # Minificar todos los scripts menos *.min.js y feedback.js usando Terser CLI
          for f in scripts/*.js; do
            base="$(basename "$f")"
            if [[ "$base" == *.min.js ]] || [[ "$base" == "feedback.js" ]]; then
              echo "Skip $base"; continue;
            fi
            out="scripts/${base%.js}.min.js"
            echo "Minify $f â†’ $out"
            pnpm exec terser "$f" \
              -o "$out" \
              -c passes=2,hoist_funs=true,drop_debugger=true \
              -m
          done
      - name: Use .min.js in HTML
        run: |
          # Reemplazar referencias a scripts no minificados por sus versiones .min.js si existen
          for html in *.html; do
            echo "Procesando $html"
            for min in scripts/*.min.js; do
              base="$(basename "$min" .min.js)"
              sed -i "s#src=\"scripts/$base.js\"#src=\"scripts/$base.min.js\"#g" "$html"
            done
          done
      - name: Generate image variants (AVIF/WebP)
        run: pnpm run images:gen || true
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
